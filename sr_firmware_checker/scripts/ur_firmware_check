#!/bin/bash -e

request_firmware_version(){
  echo "polyscopeversion" | (exec 3<>/dev/tcp/$1/29999; cat >&3; cat <&3; exec 3<&-)
}

check_firmware_from_ip(){
  responded=false
  while read -r cmd; do
    if [[ $cmd =~ "URSoftware" ]]; then
      while read firmware; do
        if [[ $firmware != "" ]]; then
          if [[ $cmd =~ $firmware ]]; then
            echo -e "\e[32mUR version $cmd is supported by Shadow\e[0m"
            responded=true
            break 2
          fi
        fi
      done <../config/known_good_firmware.txt
      echo -e "\e[33mUR version $cmd is NOT supported by Shadow. Use our software at your own risk\e[0m"
      responded=true
      break
    fi
  done < <(timeout 5 bash -c "request_firmware_version $1")
  if [[ $responded == false ]]; then
    echo "\e[31mUR robot did not respond\e[0m"
  fi
}

source /opt/ros/kinetic/setup.bash
source ~/projects/shadow_robot/base/devel/setup.bash 
source ~/projects/shadow_robot/base_deps/devel/setup.bash 

arm_config_files=$(rosls sr_ur_arm_config/config/ | grep robot_hw.yaml)
for arm in $arm_config_files ; do 
  arm_ip=$(roscat sr_ur_arm_config $arm | grep robot_ip_address | sed -r 's/robot_ip_address: //g')
  echo "Checking firmware of arm at: $arm_ip"
  check_firmware_from_ip $arm_ip
done

